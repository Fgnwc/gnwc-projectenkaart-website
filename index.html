<!DOCTYPE html>
<html lang="nl">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Project Map</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

  <style>
    /* =============== Base layout =============== */


    /* Boven- en onderrand in huisstijlkleuren zonder scrollbalk */
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      /* voorkomt scroll door borders */
      border-top: 5px solid #86bc25;
      /* groen */
      border-bottom: 10px solid #b3cbd9;
      /* blauwgrijs */
      overflow: hidden;
      /* extra zekerheid: geen scrollbalken */
    }

    #map {
      height: 100%;
      width: 100%;
    }


    /* =============== Title badge (top center) =============== */
    .map-title {
      position: absolute;
      top: 0px;
      left: 50%;
      transform: translateX(-50%);
      background: #86bc25;
      color: #436026;
      padding: 8px 20px;
      border-radius: 10px;
      z-index: 1000;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .15);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      text-align: center;
    }

    .map-title h1 {
      margin: 0;
      font-size: 25px;
      font-weight: 700;
    }

    .map-title p {
      margin: 2px 0 0;
      font-size: 14px;
      color: #e7f2cf;
    }

    /* =============== Leaflet tooltip / pin-label look =============== */
    .name-id-tooltip {
      font-weight: 600;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .15);
      border: 1px solid rgba(0, 0, 0, .15);
    }

    .leaflet-tooltip {
      background: #fff;
      color: #222;
      border: 1px solid rgba(0, 0, 0, .25);
    }

    .leaflet-tooltip a,
    .leaflet-popup-content a {
      color: #1a73e8;
      text-decoration: underline;
      font-weight: 500;
    }

    .leaflet-tooltip a:hover,
    .leaflet-popup-content a:hover {
      color: #0b59c7;
      text-decoration: none;
    }

    /* =============== Spacing for top-right control stack =============== */
    .leaflet-top.leaflet-right {
      margin-top: 8px;
    }

    .leaflet-top.leaflet-right .leaflet-control {
      margin-bottom: 8px;
    }

    /* =============== Uniform control width (desktop) =============== */
    .leaflet-top.leaflet-right .leaflet-control {
      width: 240px;
      min-width: 240px;
      box-sizing: border-box;
      border-radius: 8px;
    }

    .leaflet-control .legend,
    .leaflet-control-layers {
      width: 100%;
      box-sizing: border-box;
      font: 14px/1.3 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: #436026;
    }

    /* =============== Custom “card” look for legend/filter =============== */
    .legend {
      background: #fff;
      padding: 10px 12px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, .2);
      max-height: 45vh;
      overflow: auto;
    }

    .legend h4 {
      margin: 0 0 6px;
      font-size: 14px;
    }

    .legend .group {
      margin-bottom: 10px;
    }

    .legend .row {
      display: flex;
      align-items: center;
      gap: 6px;
      margin: 3px 0;
    }

    .legend .controls {
      display: flex;
      gap: 8px;
      margin: 6px 0 8px;
      flex-wrap: wrap;
    }

    .legend .controls button {
      font-size: 12px;
      padding: 2px 6px;
      border: 1px solid #ddd;
      background: #f6f6f6;
      border-radius: 4px;
      cursor: pointer;
    }

    .legend .controls button:hover {
      background: #eee;
    }

    /* =============== Pretty checkboxes (filter & legend) =============== */
    .legend input[type="checkbox"],
    .leaflet-control-layers input[type="checkbox"],
    .leaflet-control-layers input[type="radio"] {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      width: 16px;
      height: 16px;
      border: 2px solid #86bc25;
      border-radius: 3px;
      background: #fff;
      cursor: pointer;
      position: relative;
      transition: .2s;
    }

    .legend input[type="checkbox"]:checked,
    .leaflet-control-layers input[type="checkbox"]:checked,
    .leaflet-control-layers input[type="radio"]:checked {
      background: #86bc25;
      border-color: #86bc25;
    }

    .legend input[type="checkbox"]:checked::after,
    .leaflet-control-layers input[type="checkbox"]:checked::after,
    .leaflet-control-layers input[type="radio"]:checked::after {
      content: '';
      position: absolute;
      left: 4px;
      top: 0px;
      width: 4px;
      height: 8px;
      border: solid #fff;
      border-width: 0 2px 2px 0;
      transform: rotate(45deg);
    }

    /* =============== Leaflet layer control (expanded look) =============== */
    .leaflet-control-layers {
      background: #fff;
      border: 2px solid #86bc25;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .15);
    }

    .leaflet-control-layers-base label,
    .leaflet-control-layers-overlays label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 14px;
      padding: 2px 6px;
    }

    .leaflet-control-layers label:hover {
      background: rgba(134, 188, 37, .1);
    }

    /* =============== Layer control (collapsed / hamburger) =============== */
    .leaflet-control-layers.collapsed {
      background: transparent !important;
      border: 0 !important;
      box-shadow: none !important;
      padding: 0 !important;
    }

    .leaflet-control-layers.collapsed .leaflet-control-layers-toggle {
      display: block;
      width: 36px;
      height: 36px;
      border-radius: 8px;
      background-color: #86bc25 !important;
      background-image: none !important;
      border: 0 !important;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .15);
      position: relative;
    }

    .leaflet-control-layers.collapsed .leaflet-control-layers-toggle::after {
      content: '≡';
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      left: 8px;
      color: #fff;
      font-weight: 700;
      font-size: 18px;
      line-height: 1;
      margin: 0;
    }

    /* remove Leaflet bar residue */
    .leaflet-bar .leaflet-control-layers-toggle,
    .leaflet-bar .leaflet-control-layers-toggle:hover {
      border: none !important;
    }

    /* =============== Collapsible panels (legend/filter) =============== */
    .legend details.panel {
      padding: 0;
    }

    .legend details.panel>summary {
      list-style: none;
      cursor: pointer;
      padding: 8px 10px;
      font-weight: 600;
      color: #436026;
      background: #f6fbef;
      border-radius: 6px 6px 0 0;
    }

    .legend details.panel[open]>summary {
      border-bottom: 1px solid #e3efcf;
    }

    .legend .panel-body {
      padding: 8px 10px 10px;
    }

    /* =============== Responsive: move stack to bottom on small screens =============== */
    @media (max-width: 768px) {
      .leaflet-top.leaflet-right {
        top: auto;
        bottom: 8px;
        right: 0;
        left: auto;
      }

      .leaflet-top.leaflet-right .leaflet-control {
        width: 92vw;
        max-width: 360px;
        margin-right: 8px;
      }

      .leaflet-control-layers {
        width: 100%;
      }

      .leaflet-top.leaflet-right .leaflet-control {
        margin-bottom: 8px;
      }
    }
  </style>
</head>

<body>
  <!-- Title -->
  <div class="map-title">
    <h1>GNWC Projectenkaart</h1>
    <p>Update: oktober 2025</p>
  </div>

  <!-- Map container -->
  <div id="map"></div>

  <!-- Leaflet & Turf -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>

  <script>
    // =============== Config ===============
// Gebruik jsDelivr CDN voor betrouwbare toegang (ook met CORS)
const GEOJSON_URL = 'https://cdn.jsdelivr.net/gh/Fgnwc/gnwc-geojson@main/polygons.geojson?v=' + Date.now();

    const NAME_FIELD = 'fid';           // number shown inside marker
    const ID_FIELD = 'Projectnaam';   // title in tooltip/popup
    const LABEL_ZOOM = 20;              // show marker text when zoomed in

    // =============== Map & basemaps ===============
    const map = L.map('map', { preferCanvas: true });
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 20, attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    const esriSat = L.tileLayer(
      'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
      { maxZoom: 20, attribution: 'Tiles © Esri — Source: Esri, Maxar, Earthstar Geographics' }
    );

    // =============== Panes & groups ===============
    const wijkaanpakPane = map.createPane('wijkaanpak'); // keep below others
    wijkaanpakPane.style.zIndex = 350;
    wijkaanpakPane.style.pointerEvents = 'auto';

    const polygonLayer = L.layerGroup().addTo(map);
    const centroidPins = L.layerGroup().addTo(map);

    // =============== Styles ===============
    const colorCache = {};
    const palette = ['#4e79a7', '#f28e2b', '#e15759', '#76b7b2', '#59a14f', '#edc949', '#af7aa1', '#ff9da7', '#9c755f', '#bab0ab'];

    function pickColor(key) { // color by key with repeat palette
      if (!key) return '#4e79a7';
      if (!colorCache[key]) colorCache[key] = palette[Object.keys(colorCache).length % palette.length];
      return colorCache[key];
    }

    function styleFeature(feature) { // fill style for non-Wijkaanpak
      const name = feature.properties?.[NAME_FIELD];
      return { color: '#333', weight: 1, fillColor: pickColor(name), fillOpacity: 0.35 };
    }

    function styleWijkaanpak() { // dashed outline, no fill
      return {
        pane: 'wijkaanpak', color: '#436026', weight: 4,
        dashArray: '8 6', fill: false, fillOpacity: 0, opacity: 1
      };
    }

    function setHoverStyle(layer, isHover) { // highlight on hover
      const baseWeight = layer.options.weight ?? 1;
      const newStyle = { weight: isHover ? baseWeight + 1 : baseWeight };
      if (layer.options.fill !== false) newStyle.fillOpacity = isHover ? 0.55 : 0.35;
      layer.setStyle(newStyle);
    }

    // =============== Tooltip/Popup content ===============
    function buildHoverHTML(props) { // bold title, normal desc, optional website
      if (!props) return '';
      const name = props[ID_FIELD];
      const desc = props['Beschrijving'];
      const site = props['Website'];

      const nameHtml = (name && String(name).trim())
        ? `<div><b>${name}</b></div>` : '';
      const descHtml = (desc && String(desc).trim())
        ? `<div>${desc}</div>` : '';

      let siteHtml = '';
      if (site && String(site).trim()) {
        const raw = String(site).trim();
        const fullUrl = /^https?:\/\//i.test(raw) ? raw : `https://${raw}`;
        const label = fullUrl.replace(/^https?:\/\//i, '').replace(/\/$/, '');
        siteHtml = `<div><a href="${fullUrl}" target="_blank" rel="noopener noreferrer">${label}</a></div>`;
      }
      return nameHtml + descHtml + siteHtml;
    }

    // =============== Data stores ===============
    const featureEntries = [];                       // { poly, marker, props }
    const unique = { Projectstatus: new Set() };   // filter values
    const selected = { Projectstatus: new Set() };   // active filter

    // =============== Helpers ===============
    function isWijkaanpakFeature(f) {
      return String(f.properties?.Projecttype ?? '').trim().toLowerCase() === 'wijkaanpak';
    }

    function updateVisibility() { // filter-driven show/hide
      featureEntries.forEach(({ poly, marker, props }) => {
        const status = props.Projectstatus ?? '—';
        const show = selected.Projectstatus.has(status);
        if (show) {
          if (!map.hasLayer(poly)) poly.addTo(polygonLayer);
          if (!map.hasLayer(marker)) centroidPins.addLayer(marker);
        } else {
          if (map.hasLayer(poly)) polygonLayer.removeLayer(poly);
          if (map.hasLayer(marker)) centroidPins.removeLayer(marker);
        }
      });
    }

    function updateMarkerLabels() { // show name tooltips on high zoom
      const show = map.getZoom() >= LABEL_ZOOM;
      featureEntries.forEach(({ marker }) => show ? marker.openTooltip() : marker.closeTooltip());
    }

    // =============== Load & render GeoJSON ===============
    fetch(GEOJSON_URL)
      .then(r => r.json())
      .then(data => {
        // -- Wijkaanpak (under) --
        const gjWijkaanpak = L.geoJSON(data, {
          filter: isWijkaanpakFeature,
          pane: 'wijkaanpak',
          interactive: true,
          style: styleWijkaanpak,
          onEachFeature: (feature, layer) => {
            const props = feature.properties || {};
            const status = props.Projectstatus ?? '—';
            unique.Projectstatus.add(status);

            const html = buildHoverHTML(props);
            if (html) layer.bindTooltip(html, { sticky: true, direction: 'top', interactive: true });
            layer.on({
              mouseover: e => setHoverStyle(e.target, true),
              mouseout: e => setHoverStyle(e.target, false),
              click: e => { layer.closeTooltip(); layer.openPopup(e.latlng); }
            });
            layer.bindPopup(`<div>${html}</div>`, { autoPan: true, closeButton: true, maxWidth: 320 });

            let latlng;
            try { const c = turf.centroid(feature).geometry.coordinates; latlng = [c[1], c[0]]; }
            catch { latlng = layer.getBounds().getCenter(); }

            const id = props?.[ID_FIELD] ?? '—';
            const fidValue = props?.[NAME_FIELD] ?? '';
            const icon = L.divIcon({
              className: 'custom-pin',
              html: `
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="32" viewBox="0 0 20 30">
                  <path fill="#86bc25" stroke="#333" stroke-width="1"
                        d="M10 0C4.5 0 0 4.5 0 10c0 7.5 10 20 10 20s10-12.5 10-20C20 4.5 15.5 0 10 0z"/>
                  <circle cx="10" cy="10" r="7" fill="white"/>
                  <text x="10" y="13" text-anchor="middle" font-size="8" font-weight="700" fill="#436026">${fidValue}</text>
                </svg>`,
              iconAnchor: [10, 26], popupAnchor: [0, -22]
            });
            const marker = L.marker(latlng, { icon });
            marker.bindTooltip(`${id}`, { permanent: false, direction: 'auto', className: 'name-id-tooltip', offset: [0, 0] });
            marker.bindPopup(`<div>${html}</div>`);
            featureEntries.push({ poly: layer, marker, props });
          }
        });

        // -- Others (above) --
        const gjOverig = L.geoJSON(data, {
          filter: f => !isWijkaanpakFeature(f),
          style: styleFeature,
          onEachFeature: (feature, layer) => {
            const props = feature.properties || {};
            const status = props.Projectstatus ?? '—';
            unique.Projectstatus.add(status);

            const html = buildHoverHTML(props);
            if (html) layer.bindTooltip(html, { sticky: true, direction: 'top', interactive: true });
            layer.on({
              mouseover: e => setHoverStyle(e.target, true),
              mouseout: e => setHoverStyle(e.target, false),
              click: e => { layer.closeTooltip(); layer.openPopup(e.latlng); }
            });
            layer.bindPopup(`<div>${html}</div>`, { autoPan: true, closeButton: true, maxWidth: 320 });

            let latlng;
            try { const c = turf.centroid(feature).geometry.coordinates; latlng = [c[1], c[0]]; }
            catch { latlng = layer.getBounds().getCenter(); }

            const id = props?.[ID_FIELD] ?? '—';
            const fidValue = props?.[NAME_FIELD] ?? '';
            const icon = L.divIcon({
              className: 'custom-pin',
              html: `
                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="32" viewBox="0 0 20 30">
                  <path fill="#86bc25" stroke="#333" stroke-width="1"
                        d="M10 0C4.5 0 0 4.5 0 10c0 7.5 10 20 10 20s10-12.5 10-20C20 4.5 15.5 0 10 0z"/>
                  <circle cx="10" cy="10" r="7" fill="white"/>
                  <text x="10" y="13" text-anchor="middle" font-size="8" font-weight="700" fill="#436026">${fidValue}</text>
                </svg>`,
              iconAnchor: [10, 26], popupAnchor: [0, -22]
            });
            const marker = L.marker(latlng, { icon });
            marker.bindTooltip(`${id}`, { permanent: false, direction: 'auto', className: 'name-id-tooltip', offset: [0, 0] });
            marker.bindPopup(`<div>${html}</div>`);
            featureEntries.push({ poly: layer, marker, props });
          }
        });

        // Add layers & fit
        gjWijkaanpak.addTo(polygonLayer);
        gjOverig.addTo(polygonLayer);
        gjWijkaanpak.bringToBack();

        const allBounds = gjOverig.getBounds().extend(gjWijkaanpak.getBounds());
        map.fitBounds(allBounds, { padding: [40, 40] });

        // Maximaal uitzoomen tot het niveau waarop alle projecten zichtbaar zijn
        const projectBounds = allBounds; // jouw berekende grens
        map.setMaxBounds(projectBounds);
        map.setMinZoom(map.getZoom()); // voorkomt verder uitzoomen

        // Kleine marge zodat je nog een beetje kunt slepen
        const paddedBounds = projectBounds.pad(0.2); // 10% marge rond projecten
        map.setMaxBounds(paddedBounds);

        // de kaart automatisch terugveert bij te ver pannen
        map.on('drag', function () {
          map.panInsideBounds(paddedBounds, { animate: true });
        });

        // Init filter selections
        selected.Projectstatus = new Set(unique.Projectstatus);

        // Add pins once, then sync visibility/labels
        featureEntries.forEach(({ marker }) => centroidPins.addLayer(marker));
        updateVisibility();
        updateMarkerLabels();
        map.on('zoomend', updateMarkerLabels);

        // =============== Controls (top-right) ===============
        // -- Base/overlay switcher (collapsed by default) --
        L.control.layers(
          { 'OpenStreetMap': osm, 'Satelliet (Esri)': esriSat },
          { 'Vlakken': polygonLayer, 'Naam/ID pins': centroidPins },
          { collapsed: true, position: 'topright' }
        ).addTo(map);

        // -- Legend (symbols) --
        const legendCtrl = L.control({ position: 'topright' });
        legendCtrl.onAdd = function () {
          const div = L.DomUtil.create('div', 'legend');
          div.innerHTML = `
    <details class="panel" open>
      <summary>Legenda</summary>
      <div class="panel-body">
        <div class="row">
          <svg width="22" height="32" viewBox="0 0 20 30" style="vertical-align:middle;">
            <path fill="#86bc25" stroke="#333" stroke-width="1"
              d="M10 0C4.5 0 0 4.5 0 10c0 7.5 10 20 10 20s10-12.5 10-20C20 4.5 15.5 0 10 0z"/>
            <circle cx="10" cy="10" r="7" fill="white"/>
          </svg>
          <span>GNWC-project</span>
        </div>
        <div class="row" style="align-items:center; margin-top:6px;">
          <svg width="30" height="10">
            <line x1="0" y1="5" x2="30" y2="5"
              stroke="#436026" stroke-width="4" stroke-dasharray="8 6"/>
          </svg>
          <span>Wijkaanpakgebied</span>
        </div>
      </div>
    </details>
  `;
          return div;
        };
        legendCtrl.addTo(map);

        // -- Filter: Projectstatus (collapsible + responsive open/close) --
        buildStatusFilter();
        function buildStatusFilter() {
          const ctrl = L.control({ position: 'topright' });
          ctrl.onAdd = function () {
            const div = L.DomUtil.create('div', 'legend');

            function onCheckboxChange(e) {
              const val = e.target.dataset.value;
              if (e.target.checked) selected.Projectstatus.add(val);
              else selected.Projectstatus.delete(val);
              updateVisibility();
            }

            const details = document.createElement('details');
            details.className = 'panel';
            details.setAttribute('open', ''); // open on desktop

            const summary = document.createElement('summary');
            summary.textContent = 'Projectstatus';
            details.appendChild(summary);

            const body = document.createElement('div');
            body.className = 'panel-body';

            const wrapper = document.createElement('div'); wrapper.className = 'group';
            const controls = document.createElement('div'); controls.className = 'controls';

            const btnAll = document.createElement('button'); btnAll.type = 'button'; btnAll.textContent = 'Alles';
            const btnNone = document.createElement('button'); btnNone.type = 'button'; btnNone.textContent = 'Geen';
            controls.appendChild(btnAll); controls.appendChild(btnNone);
            wrapper.appendChild(controls);

            const values = Array.from(unique.Projectstatus).filter(v => v != null);
            values.sort((a, b) => String(a).localeCompare(String(b), 'nl', { numeric: true }));

            values.forEach(v => {
              const row = document.createElement('label'); row.className = 'row';
              const cb = document.createElement('input'); cb.type = 'checkbox';
              cb.checked = selected.Projectstatus.has(v);
              cb.dataset.value = v; cb.addEventListener('change', onCheckboxChange);
              const span = document.createElement('span'); span.textContent = v;
              row.appendChild(cb); row.appendChild(span); wrapper.appendChild(row);
            });

            btnAll.onclick = () => {
              values.forEach(v => selected.Projectstatus.add(v));
              wrapper.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
              updateVisibility();
            };
            btnNone.onclick = () => {
              selected.Projectstatus.clear();
              wrapper.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
              updateVisibility();
            };

            body.appendChild(wrapper);
            details.appendChild(body);
            div.appendChild(details);
            return div;
          };
          ctrl.addTo(map);

          // Responsive: auto-open desktop, auto-close mobile
          const mq = window.matchMedia('(max-width: 768px)');
          function applyPanelOpenState() {
            document.querySelectorAll('.legend details.panel').forEach(d => {
              if (mq.matches) d.removeAttribute('open'); else d.setAttribute('open', '');
            });
          }
          applyPanelOpenState();
          if (mq.addEventListener) mq.addEventListener('change', applyPanelOpenState);
          else if (mq.addListener) mq.addListener(applyPanelOpenState);
        }
      })
      .catch(err => {
        console.error('Failed to load GeoJSON', err);
        alert('Failed to load GeoJSON. Controleer GEOJSON_URL en de console.');
      });
  </script>
</body>

</html>